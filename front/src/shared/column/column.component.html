<div *ngIf="!isSQL()">
	Column Management is not yet supported on NoSQL databases
</div>

<div *ngIf="isSQL()" [formGroup]="form" class="container">
	<div *ngIf="form.get('old')" style="display: flex; align-items: center;">
		<mat-card formGroupName="old" class="oldValues">
			<mat-card-header>
				<mat-form-field appearance="outline">
					<mat-label>Column Name</mat-label>
					<input autocomplete="off"
						   formControlName="name"
						   matInput>
				</mat-form-field>
			</mat-card-header>

			<mat-card-content>
				<div>
					<mat-form-field appearance="fill">
						<mat-label>Type</mat-label>
						<textarea
							cdkTextareaAutosize
							formControlName="type"
							matInput
							type="text">
						</textarea>
					</mat-form-field>
				</div>
				<div>
					<mat-form-field *ngIf="extraAttributes.length" appearance="fill">
						<mat-label>Extras</mat-label>
						<mat-select formControlName="extra" multiple></mat-select>
					</mat-form-field>

					<mat-slide-toggle
						color="primary"
						formControlName="nullable">
						Nullable
					</mat-slide-toggle>

					<mat-form-field>
						<mat-label>Default Value on Null</mat-label>
						<input autocomplete="off"
							   formControlName="defaut"
							   matInput>
					</mat-form-field>
				</div>
			</mat-card-content>
		</mat-card>
	</div>

	<div formArrayName="columns" class="newValues">
		<mat-card *ngFor="let column of formColumn.controls; let i = index"
				  [formGroupName]="i">

			<mat-card-header>
				<mat-form-field appearance="outline">
					<mat-label>Column Name</mat-label>
					<input autocomplete="off"
						   formControlName="name"
						   matInput>
					<mat-error *ngIf="column.get('name')?.errors && column.get('name')!.errors!['pattern']">
						Prefer alpha, numeric and "_", "-" with 2 min chars
					</mat-error>
					<mat-error *ngIf="column.get('name')?.errors && column.get('name')!.errors!['unique']">
						Name already used
					</mat-error>
				</mat-form-field>
			</mat-card-header>

			<mat-card-content>
				<div>
					<mat-form-field appearance="fill">
						<mat-label>Type</mat-label>
						<textarea
							cdkTextareaAutosize
							formControlName="type"
							matInput
							type="text">
						</textarea>
						<mat-error *ngIf="column.get('type')?.errors && column.get('type')!.errors!['required']">
							Type is required
						</mat-error>
						<mat-error *ngIf="column.get('type')?.errors && column.get('type')!.errors!['checkParams']">
							Parentheses contains error
						</mat-error>
					</mat-form-field>

					<div>
						<button (click)="typeSuggestion.open()"
								color="primary"
								mat-icon-button
								matTooltip="Choose from type list">
							<span class="material-symbols-outlined notranslate">
								title
							</span>
						</button>

						<mat-select
							#typeSuggestion
							(selectionChange)="column.get('type')?.patchValue($event.value)">
							<mat-optgroup *ngFor="let group of selectedServer!.driver.language.typeGroups"
										  [label]="group.name">
								<mat-option *ngFor="let type of group.list" [value]="type.id">
									<span
										[matTooltip]="type.description ? type.description : ''"
										[style.color]="type.bold ? '#ff9800' : null"
										matTooltipPosition="left">
										{{type.id}}
									</span>
								</mat-option>
							</mat-optgroup>
						</mat-select>

						<button (click)="fctSuggestion.open()"
								*ngIf="selectedServer!.driver.language.fctAsDefault"
								color="primary"
								mat-icon-button
								matTooltip="Choose from function list">
							<span class="material-symbols-outlined notranslate">
								function
							</span>
						</button>

						<mat-select
							#fctSuggestion
							(selectionChange)="column.get('type')?.patchValue($event.value)">
							<mat-option *ngFor="let fct of selectedServer!.driver.language.functions | keyvalue"
										[value]="fct.key + ' ' + fct.value || '(expression)'">
								{{fct.key}} {{fct.value}}
							</mat-option>
						</mat-select>

						<button
							(click)="column.get('type')!.patchValue(column.get('type')?.value && column.get('type')!.value.endsWith('[]') ? column.get('type')!.value.substring(0, column.get('type')!.value.indexOf('[]')) : column.get('type')!.value + '[]')"
							*ngIf="selectedServer!.driver.language.arrayType"
							[class.mat-raised-button]="column.get('type')?.value && column.get('type')!.value.endsWith('[]')"
							color="primary"
							mat-icon-button
							matTooltip="Set type an array of">
							<span class="material-symbols-outlined notranslate">
								data_array
							</span>
						</button>
					</div>
				</div>

				<div>
					<mat-form-field *ngIf="extraAttributes.length" appearance="fill">
						<mat-label>Extras</mat-label>
						<mat-select formControlName="extra" multiple>
							<ng-container *ngFor="let ext of extraAttributes">
								<mat-option [value]="ext">
									{{ext}}
								</mat-option>
							</ng-container>
						</mat-select>
					</mat-form-field>

					<mat-slide-toggle
						color="primary"
						formControlName="nullable">
						Nullable
					</mat-slide-toggle>

					<mat-form-field [style.opacity]="column.get('nullable')!.value ? 1 : 0.5">
						<mat-label>Default Value on Null</mat-label>
						<input autocomplete="off"
							   formControlName="defaut"
							   matInput>
					</mat-form-field>
				</div>

				<div *ngIf="!form.get('old')" class="actions">
					<button (click)="copyColumn(column.value)"
							color="primary"
							mat-icon-button
							matTooltip="Duplicate Column">
						<span class="material-symbols-outlined notranslate">
							content_copy
						</span>
					</button>

					<button (click)="formColumn.removeAt(i)"
							*ngIf="formColumn.controls.length > 1"
							color="warn"
							mat-icon-button
							matTooltip="Delete Column">
						<span class="material-symbols-outlined notranslate">
							delete
						</span>
					</button>
				</div>
			</mat-card-content>
		</mat-card>
	</div>
</div>
