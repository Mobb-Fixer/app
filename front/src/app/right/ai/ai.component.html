<ng-container *ngIf="licence?.plan === 'free'">
	You must get a plan to access this feature

	<a href="https://webdb.app/price" mat-stroked-button target="_blank">
		<span class="material-symbols-outlined notranslate">
			subscriptions
		</span>
		Plans
	</a>
</ng-container>

<div [hidden]="licence?.plan === 'free'"
	 fxFlexFill
	 fxLayout="column"
	 fxLayoutAlign="space-between none">

	<mat-toolbar
		fxLayout="row"
		fxLayoutAlign="space-between center"
		style="padding: 20px; gap: 20px; z-index: 100;">

		<div>
			<a href="https://platform.openai.com/account"
			   mat-button
			   matTooltip="OpenAI account page"
			   target="_blank">
				<mat-icon svgIcon="chatgpt"></mat-icon>
				ChatGPT
			</a>
		</div>

		<div fxLayout="row"
			 fxLayoutAlign="space-between center"
			 style="width: 100%">

			<div>
				<mat-form-field
					[hidden]="!key || changing"
					appearance="fill"
					style="margin-bottom: -1.25em">
					<mat-label>Pre-sent data</mat-label>
					<mat-select #select multiple [(ngModel)]="preSent">
						<mat-option [value]="'structure'">
							Tables structure and relations
						</mat-option>
						<mat-option [value]="'views'">
							All views
						</mat-option>
						<mat-option [value]="'triggers'">
							All triggers
						</mat-option>
						<mat-option [value]="5">
							5 rows of each table
						</mat-option>
						<mat-option [value]="15">
							15 rows of each table
						</mat-option>
						<mat-option [value]="50">
							50 rows of each table
						</mat-option>
					</mat-select>
				</mat-form-field>
			</div>

			<div fxLayout="row">
				<div *ngIf="changing">
					<mat-form-field style="width: 400px; margin-bottom: -1.25em">
						<mat-label>Key</mat-label>
						<input #keyInput
							   [ngModel]="key"
							   matInput>
					</mat-form-field>

					<button
						(click)="setKey(keyInput.value)"
						mat-raised-button>
						Save
					</button>
				</div>

				<button
					(click)="changing = !changing"
					*ngIf="!changing"
					mat-button
					matTooltip="Change Key">
					<span class="material-symbols-outlined notranslate">
						key
					</span>
				</button>

				<button
					(click)="chat = []; saveChat()"
					*ngIf="chat.length"
					mat-button
					matTooltip="Clear Conversation">
					<span class="material-symbols-outlined notranslate">
						clear_all
					</span>
				</button>
			</div>
		</div>
	</mat-toolbar>

	<h4
		*ngIf="!key"
		fxLayout="row"
		fxLayoutAlign="center center"
		style="margin: 40px"
	>
		First, generate a key from&nbsp;<a href="https://platform.openai.com/account/api-keys" target="_blank">OpenAI</a>, then save it there ⇧
	</h4>

	<div *ngIf="!chat.length || !key">
		<h3 style="text-align: center; border-bottom: 1px dashed grey">Some examples</h3>
		<div id="examples">
			<button (click)="sendMessage(example);"
					[disabled]="!key"
					*ngFor="let example of examples"
					mat-stroked-button>
				{{example}}
			</button>
		</div>
	</div>

	<div id="container" *ngIf="key && chat.length">
		<mat-card *ngFor="let ch of chat"
				  [style.background-color]="ch.error ? '#f44336' : ch.user === Role.Assistant ? '#1e1e1e' : undefined">
			<mat-card-content>

				<div *ngFor="let mrk of ch.marked" class="marked">

					<div *ngIf="mrk.code" class="responseCode">
						<div class="actions">
							<button
								(click)="runQuery(mrk.code);"
								color="primary"
								matTooltip="Run and send result to IA"
								matTooltipPosition="left"
								mat-icon-button>
								<span class="material-symbols-outlined notranslate">
									fast_forward
								</span>
							</button>
							<button
								(click)="snackBar.open('Copied to clipboard', '╳', {duration: 3000})"
								[cdkCopyToClipboard]="mrk.code"
								matTooltip="Copy code to clipboard"
								matTooltipPosition="left"
								color="primary"
								mat-icon-button>
								<span class="material-symbols-outlined notranslate">
									file_copy
								</span>
							</button>
						</div>
						<pre><code [highlight]="mrk.code" [lineNumbers]="true"></code></pre>
					</div>

					<ng-container *ngIf="mrk.html">
						<button
							class="actions"
							style="margin-top: -10px;"
							*ngIf="ch.user === Role.User"
							(click)="message.value = ch.txt"
							mat-icon-button>
							<span class="material-symbols-outlined notranslate">
								edit
							</span>
						</button>
						<div [innerHTML]="mrk.html"></div>
					</ng-container>
				</div>

			</mat-card-content>
		</mat-card>
	</div>

	<mat-progress-bar *ngIf="isLoading" mode="indeterminate"></mat-progress-bar>

	<div style="padding: 6px" [hidden]="!key">
		<mat-form-field (keydown.enter)="sendMessage(message.value); message.value = ''"
						appearance="fill"
						class="sendMessage">
			<mat-label>Ask anything about `{{selectedDatabase?.name}}`</mat-label>
			<textarea #message matInput cdkTextareaAutosize></textarea>
			<button (click)="sendMessage(message.value); message.value = ''"
					[disabled]="!message.value"
					mat-icon-button
					matSuffix>
				<mat-icon>send</mat-icon>
			</button>
		</mat-form-field>
	</div>
</div>
