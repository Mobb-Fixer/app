<mat-toolbar fxLayout="row" fxLayoutAlign="space-between center">
	<mat-form-field style="width: 250px" appearance="standard">
		<input #filter
			   (keyup)="filterChanged(filter.value)"
			   placeholder="Search Server | Database"
			   autocomplete="off"
			   matInput>
		<button (click)="filter.value=''; filterChanged(filter.value)" *ngIf="filter.value" aria-label="Clear"
				mat-icon-button
				matSuffix>
			<mat-icon>close</mat-icon>
		</button>
	</mat-form-field>

	<button
		(click)="ngOnInit()"
		[disabled]="loading !== LoadingStatus.DONE"
		mat-flat-button>
		<span class="material-symbols-outlined notranslate">
			wifi_find
		</span>
		Rescan Connections
	</button>

	<mat-checkbox
		[(ngModel)]="systemDbs"
		style="font-size: 14px"
		color="primary">
		Show system DBs
	</mat-checkbox>

	<app-top-right></app-top-right>
</mat-toolbar>

<div *ngIf="loading !== LoadingStatus.DONE"
	 style="height: calc(100vh - 56px); justify-content: center; display: flex;">
	<div style="align-self: center;">

		<ng-container *ngIf="loading === LoadingStatus.LOADING">
			<mat-spinner
				mode="indeterminate"
				style="margin: 0px auto;"></mat-spinner>
			<h2 style="color: #2196f3">Scanning Connections</h2>
		</ng-container>

		<div *ngIf="loading === LoadingStatus.ERROR">
			<mat-error>
				<h3>Backend unreachable, please check logs directly from it</h3>
			</mat-error>

			<mat-divider style="margin: 20px 0px;"></mat-divider>

			<div style="display: flex; justify-content: space-between;">
				<button
					mat-stroked-button
					color="primary"
					(click)="ngOnInit()">
					<span class="material-symbols-outlined notranslate">
						refresh
					</span>
					Reload Page
				</button>

				<a [href]="'https://gitlab.com/web-db/public/-/issues/new?issue[title]=Problem%20reaching%20the%20backend&issue[description]=Here%20is%20the%20error%20log:%0A'"
				   mat-stroked-button
				   target="_blank">
					<span class="material-symbols-outlined notranslate">
						bug_report
					</span>
					Send Report
				</a>
			</div>
		</div>
	</div>
</div>

<div id="container" *ngIf="loading === LoadingStatus.DONE">

	<mat-tab-group>
		<mat-tab
			*ngFor="let status of Object.values(Status)"
			[disabled]="getServerByStatus(status).length < 1"
			[label]="status">

			<mat-card
				class="servers"
				*ngFor="let server of getServerByStatus(status)"
				[hidden]="server.hide">

				<mat-card-header>
					<mat-card-title>
						<div class="logo">
							<img src="/assets/drivers/{{server.wrapper.toLowerCase()}}.svg" />
						</div>

						<div *ngIf="server.user">
							<span class="material-symbols-outlined notranslate">
								person
							</span>
							{{server.user}}
						</div>
						<div>
							<span class="material-symbols-outlined notranslate">
								signpost
							</span>
							{{server.host}}
						</div>
						<div>
							<span class="material-symbols-outlined notranslate">
								numbers
							</span>
							{{server.port}}
						</div>

						<span
							[matTooltip]="server.ssh | json"
							*ngIf="server.ssh && server.ssh.host"
							style="margin-right: 10px"
							class="material-symbols-outlined notranslate">
							subway
						</span>

						<button
							*ngIf="(server.scanned && server.stored) || !server.scanned"
							(click)="editConnection(server)"
							style="justify-self: center"
							mat-button>
							<span class="material-symbols-outlined notranslate">
								network_manage
							</span>
							Edit Connection
						</button>
					</mat-card-title>
				</mat-card-header>

				<mat-divider vertical style="margin: -16px 20px;"></mat-divider>

				<mat-card-content>
					<ng-container *ngIf="!server.connected">
						<ng-container *ngIf="!server.scanned">
							<br>
							<mat-error>
								<div style="text-align: center">
									Unreachable or bad credentials
								</div>
							</mat-error>
						</ng-container>
						<div class="login"
							*ngIf="server.scanned"
							(keyup.enter)="loginBtn._elementRef.nativeElement.click()">
							<div>
								<mat-form-field appearance="outline">
									<mat-label>User</mat-label>
									<input #user matInput>
								</mat-form-field>
								<mat-form-field appearance="outline">
									<mat-label>Password</mat-label>
									<input #password
										   autocomplete="off"
										   matInput
										   type="{{!showPassword ? 'password' : 'text'}}">
									<mat-icon (click)="showPassword = !showPassword" matSuffix
											  style="cursor: pointer;">
										{{!showPassword ? 'visibility' : 'visibility_off'}}</mat-icon>
								</mat-form-field>
							</div>
							<div>
								<button
									#loginBtn
									(click)="login(server, user.value, password.value)"
									color="primary"
									mat-stroked-button>
									<mat-icon>login</mat-icon>
									Connect
								</button>

								<mat-spinner
									*ngIf="server.isLoading"
									[diameter]="30"
									color="primary"
								></mat-spinner>

								<button (click)="guess(server, user.value, password.value)"
										*ngIf="!server.isLoading"
										mat-stroked-button>
									<span class="material-symbols-outlined notranslate">
										lock_open_right
									</span>
									Guess Credentials
								</button>
							</div>
						</div>
					</ng-container>
					<ng-container *ngIf="server.connected">
						<mat-selection-list [multiple]="false">
							<mat-list-option
								*ngFor="let database of server.dbs"
								[disabled]="database.tables === undefined"
								[hidden]="database.hide || (!systemDbs && database.system)"
								routerLink="/{{server.name}}/{{database.name}}">
								{{database.name}}
								<ng-container *ngIf="database.tables === undefined"> [Limited]</ng-container>
								<span matTooltip="Tables"
									  matTooltipPosition="right"
									  style="position: absolute; right: 20px">
									{{database.tables?.length}}
								</span>
							</mat-list-option>
							<mat-list-option>
								<div style="text-align: center;"
									(click)="addDatabase(server)">
									<span
										style="vertical-align: middle"
										class="material-symbols-outlined notranslate">
										database
									</span>
									Create Database
								</div>
							</mat-list-option>
						</mat-selection-list>
					</ng-container>
				</mat-card-content>
			</mat-card>
		</mat-tab>
		<mat-tab>
			<ng-template mat-tab-label>
				<span class="material-symbols-outlined notranslate">
					wifi_add
				</span>
				Add Connection
			</ng-template>
			addServer
			app-edit-connection
		</mat-tab>
	</mat-tab-group>
</div>
