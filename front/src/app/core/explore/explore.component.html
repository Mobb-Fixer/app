<mat-toolbar fxLayout="row" fxLayoutAlign="space-between center">
	<div>
		<mat-form-field>
			<mat-label>Sort By</mat-label>
			<mat-select [(ngModel)]="params.sortField">
				<ng-container *ngFor="let column of displayedColumns">
					<mat-option
						*ngIf="column !== actionColum"
						[queryParams]="params"
						[routerLink]="'./'"
						[value]="column"
					>
						{{column}}
					</mat-option>
				</ng-container>
			</mat-select>
		</mat-form-field>
		<mat-button-toggle-group
			*ngIf="params.sortField"
			[(ngModel)]="params.sortDirection"
			[queryParams]="params"
			[routerLink]="'./'">
			<mat-button-toggle matTooltip="Asc" value="asc">↑</mat-button-toggle>
			<mat-button-toggle matTooltip="Desc" value="desc">↓</mat-button-toggle>
			<mat-button-toggle matTooltip="No Sort" value="">×</mat-button-toggle>
		</mat-button-toggle-group>
	</div>

	<mat-chip-list #chipList>
		<ng-container
			*ngFor="let filter of params.filter.split(';')">
			<mat-chip
				(removed)="removeFilter(filter)"
				*ngIf="filter"
				color="primary"
				selected>
				{{filter}}
				<button matChipRemove>
					<mat-icon>cancel</mat-icon>
				</button>
			</mat-chip>
		</ng-container>
	</mat-chip-list>

	<div style="display: flex; align-items: center;">
		<button
			(click)="setAutoUp()"
			[color]="autoUp ? 'primary' : null"
			[ngClass]="{'mat-raised-button' : autoUp}"
			mat-button
			matTooltip="Reload data periodically">
			<span class="material-symbols-outlined">
				repeat
			</span>
		</button>
		<mat-paginator
			(page)="changePage($event)"
			[length]="querySize"
			[pageIndex]="params.page"
			hidePageSize="true"
			pageSize="{{pageSize}}"
			showFirstLastButtons="true">
		</mat-paginator>
	</div>
</mat-toolbar>

<mat-progress-bar *ngIf="isLoading" mode="indeterminate" style="position: absolute; z-index: 10000;"></mat-progress-bar>

<div class="scrollDiv" style="height: calc(100% - 106px);">

	<table [dataSource]="dataSource" class="table mat-elevation-z8" mat-table>
		<ng-container
			*ngFor="let column of displayedColumns"
			[stickyEnd]="column === actionColum"
			matColumnDef="{{column}}"
		>
			<th *matHeaderCellDef
				mat-header-cell>

				<ng-container *ngIf="column !== actionColum">
					<input (matChipInputTokenEnd)="addFilter(column, $event)"
						   [(ngModel)]="filter[column]"
						   [matChipInputFor]="chipList"
						   matTooltip="{{column}}"
						   matTooltipPosition="above"
						   matTooltipClass="columnTooltip"
						   placeholder="{{column}}">
					<button mat-icon-button [matMenuTriggerFor]="menu" class="filterBtn">
						<span class="material-symbols-outlined">
							search
						</span>
					</button>
					<mat-menu #menu="matMenu">
						<button (click)="filter[column] = comp.symbol + ' ' + comp.example"
								*ngFor="let comp of selectedServer!.driver.availableComparator"
								mat-menu-item>
							<span>{{comp.symbol}}</span>
						</button>
					</mat-menu>
				</ng-container>

				<ng-container *ngIf="column === actionColum">
					<button (click)="removeRows()"
							[disabled]="selection.isEmpty()"
							color="warn"
							style="width: 36px;"
							mat-icon-button>
						<span class="material-symbols-outlined">
							delete
						</span>
					</button>
					<mat-checkbox
						(change)="$event ? toggleAllRows() : null"
						[checked]="selection.hasValue() && isAllSelected()"
						[indeterminate]="selection.hasValue() && !isAllSelected()"
						color="warn">
					</mat-checkbox>
				</ng-container>

			</th>
			<td *matCellDef="let row; let i = index"
				[class.selected]="selection.isSelected(row)"
				mat-cell>

				<ng-container *ngIf="column === actionColum">
					<button (click)="updateRow(i, row)"
							[hidden]="!toUpdate[i]"
							color="accent"
							mat-icon-button>
						<mat-icon>check_circle</mat-icon>
					</button>

					<button (click)="toUpdate[i] = undefined"
							[hidden]="!toUpdate[i]"
							color="warn"
							mat-icon-button>
						<mat-icon>cancel</mat-icon>
					</button>

					<button (click)="editRow(i, row)"
							[hidden]="toUpdate[i]"
							color="accent"
							mat-icon-button>
						<span class="material-symbols-outlined">
							edit
						</span>
					</button>

					<mat-checkbox
						(change)="$event ? selection.toggle(row) : null"
						(click)="shiftCheckBox($event, row); $event.stopPropagation();"
						[checked]="selection.isSelected(row)"
						[hidden]="toUpdate[i]"
						color="warn">
					</mat-checkbox>
				</ng-container>

				<ng-container *ngIf="column !== actionColum">
					<ng-container *ngIf="toUpdate[i]">
						<mat-select *ngIf="updateSuggestions[column]" [(ngModel)]="toUpdate[i][column]"
									class="toUpdate">
							<mat-option *ngFor="let suggestion of updateSuggestions[column]" [value]="suggestion">
								{{suggestion}}
							</mat-option>
						</mat-select>
						<textarea *ngIf="!updateSuggestions[column]" [(ngModel)]="toUpdate[i][column]" class="toUpdate"
								  matInput></textarea>
					</ng-container>
					<ng-container *ngIf="!toUpdate[i]">
						<a *ngIf="getFkLink(column) !== null"
						   [queryParams]="getFkParams(column, row[column])"
						   [routerLink]="getFkLink(column)">{{row[column]}}</a>
						<span *ngIf="getFkLink(column) === null">{{row[column]}}</span>
					</ng-container>
				</ng-container>
			</td>
		</ng-container>

		<tr *matHeaderRowDef="displayedColumns; sticky: true" mat-header-row></tr>
		<tr *matRowDef="let row; columns: displayedColumns;" mat-row></tr>

		<tr *matNoDataRow class="mat-row">
			<td class="mat-cell" colspan="100%">No Data</td>
		</tr>

	</table>
</div>
